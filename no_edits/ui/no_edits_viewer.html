<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No-Edits Results Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 16px;
        }
        .header { display: flex; flex-direction: column; gap: 10px; }
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .file-input { padding: 8px 12px; border: 2px solid #3498db; border-radius: 5px; background: white; cursor: pointer; }
        .task-selector { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; background: white; min-width: 220px; }
        .metrics { display: flex; gap: 10px; flex-wrap: wrap; }
        .metric { background: #ecf0f1; padding: 6px 10px; border-radius: 6px; font-size: 13px; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        .status-unknown { background: #e2e3e5; color: #383d41; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-1 { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .section-title { font-weight: 700; color: #2c3e50; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; justify-content: space-between; }
        .pill { background: #3498db; color: white; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
        .code-block {
            background: #1e1e1e; color: #d4d4d4; border: 1px solid #404040; border-radius: 6px;
            padding: 14px; font-family: 'Consolas','Monaco','Courier New', monospace; font-size: 14px; line-height: 1.5;
            white-space: pre-wrap; overflow-x: auto; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .toggle-btn { background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .toggle-btn:hover { background: #2980b9; }
        .muted { color: #666; font-size: 13px; }
        .list { display: flex; flex-wrap: wrap; gap: 6px; }
        .list .chip { background: #f0f3f6; border: 1px solid #e1e4e8; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .file-badge { background: #3498db; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .loading { text-align: center; color: #666; padding: 24px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    </style>
    <!-- Minimal, single-file, no dependencies -->
</head>
<body>
    <div class="container">
        <div class="card header">
            <div class="row">
                <h2>No-Edits Results Viewer</h2>
                <span id="fileBadge" class="file-badge" style="display:none;"></span>
            </div>
            <div class="controls">
                <input type="file" id="fileInput" class="file-input" accept=".json,.jsonl" />
                <select id="taskSelector" class="task-selector" disabled>
                    <option value="">Select a task…</option>
                </select>
                <span id="statusBadge" class="status-badge status-unknown" style="display:none;">unknown</span>
            </div>
            <div id="metrics" class="metrics"></div>
        </div>

        <div id="loading" class="loading">Load a no-edits results JSON/JSONL file to begin</div>

        <div id="content" style="display:none;">
            <div class="card">
                <div class="section-title"><span>Behavior <span id="behaviorPill" class="pill" style="display:none;"></span></span><button class="toggle-btn" onclick="toggleSection(this)">Minimize</button></div>
                <div id="behaviorInfo" class="muted">Select a task to view</div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="section-title"><span>Provided Code</span><button class="toggle-btn" onclick="toggleSection(this)">Minimize</button></div>
                    <pre id="providedCode" class="code-block">No data</pre>
                </div>
                <div class="card">
                    <div class="section-title"><span>Extracted Code (from LLM response)</span><button class="toggle-btn" onclick="toggleSection(this)">Minimize</button></div>
                    <pre id="extractedCode" class="code-block">No data</pre>
                </div>
            </div>

            <div class="grid-1">
                <div class="card">
                    <div class="section-title"><span>LLM Response</span><button class="toggle-btn" onclick="toggleSection(this)">Minimize</button></div>
                    <pre id="llmResponse" class="code-block">No data</pre>
                </div>
                <div class="card">
                    <div class="section-title"><span>Prompt</span><button class="toggle-btn" onclick="toggleSection(this)">Minimize</button></div>
                    <pre id="promptBlock" class="code-block">No data</pre>
                </div>
            </div>

            <div class="card">
                <div class="section-title"><span>Details</span><button class="toggle-btn" onclick="toggleSection(this)">Minimize</button></div>
                <div class="row" style="margin-bottom:8px;">
                    <div class="muted">Functions mentioned:</div>
                    <div id="functionsList" class="list"></div>
                </div>
                <div class="muted" id="detailsText">—</div>
                <div class="muted" id="tokenUsage" style="margin-top:6px;"> </div>
            </div>
        </div>
    </div>

    <script>
        let resultsData = null;
        let tasks = [];

        const fileInput = document.getElementById('fileInput');
        const fileBadge = document.getElementById('fileBadge');
        const taskSelector = document.getElementById('taskSelector');
        const statusBadge = document.getElementById('statusBadge');
        const metricsDiv = document.getElementById('metrics');
        const behaviorInfo = document.getElementById('behaviorInfo');
        const behaviorPill = document.getElementById('behaviorPill');
        const providedCode = document.getElementById('providedCode');
        const extractedCode = document.getElementById('extractedCode');
        const llmResponse = document.getElementById('llmResponse');
        const promptBlock = document.getElementById('promptBlock');
        const functionsList = document.getElementById('functionsList');
        const detailsText = document.getElementById('detailsText');
        const tokenUsage = document.getElementById('tokenUsage');
        const loading = document.getElementById('loading');
        const content = document.getElementById('content');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            fileBadge.style.display = 'inline-block';
            fileBadge.textContent = file.name.endsWith('.jsonl') ? 'JSONL' : 'JSON';

            const text = await file.text();
            try {
                // Try parse as normal JSON first
                resultsData = JSON.parse(text);
            } catch (_) {
                // Fallback: parse first non-empty line as JSON (JSONL with a single results object)
                const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
                if (!lines.length) return showError('Empty file');
                try {
                    resultsData = JSON.parse(lines[0]);
                } catch (err) {
                    return showError('Failed to parse JSON/JSONL: ' + err.message);
                }
            }

            if (!resultsData || !resultsData.eval) {
                return showError('File does not contain expected no-edits results structure (missing "eval").');
            }

            loading.style.display = 'none';
            content.style.display = 'block';
            populateMetrics(resultsData);
            loadTasks(resultsData);
        });

        taskSelector.addEventListener('change', () => {
            const taskId = taskSelector.value;
            if (!taskId) return;
            const task = resultsData.eval[taskId];
            displayTask(taskId, task);
        });

        function loadTasks(data) {
            tasks = Object.keys(data.eval || {}).sort();
            taskSelector.innerHTML = '<option value="">Select a task…</option>';
            for (const id of tasks) {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = id;
                taskSelector.appendChild(opt);
            }
            taskSelector.disabled = tasks.length === 0;
            if (tasks.length) {
                taskSelector.value = tasks[0];
                taskSelector.dispatchEvent(new Event('change'));
            }
        }

        function populateMetrics(data) {
            const m = data.metrics || {};
            const date = data.date ? `<div class="metric">Date: ${escapeHtml(String(data.date))}</div>` : '';
            const items = [
                `<div class=\"metric\">Evaluated: ${m.evaluated_problems ?? '-'} / ${m.total_problems ?? '-'}</div>`,
                `<div class=\"metric\">Good (no code): ${m.good_no_code_count ?? 0}</div>`,
                `<div class=\"metric\">Good (mentions others): ${m.good_no_code_mentions_others_count ?? 0}</div>`,
                `<div class=\"metric\">Wrong edit target: ${m.wrong_edit_target_count ?? 0}</div>`,
                `<div class=\"metric\">Wrong edit aux: ${m.wrong_edit_aux_count ?? 0}</div>`,
                `<div class=\"metric\">Model: ${escapeHtml(String(m.model || '-'))}</div>`,
                `<div class=\"metric\">Reasoning: ${m.is_reasoning ? 'yes' : 'no'}</div>`,
                `<div class=\"metric\">Subset: ${m.hard ? 'hard' : 'standard'}</div>`
            ];
            metricsDiv.innerHTML = items.join('') + (date || '');
        }

        function displayTask(taskId, task) {
            // Status badge
            const status = task.status || 'unknown';
            statusBadge.style.display = 'inline-block';
            statusBadge.textContent = status;
            statusBadge.className = `status-badge status-${status}`;

            // Behavior info
            const acceptable = task.is_acceptable_behavior ? 'yes' : 'no';
            behaviorInfo.innerHTML = `
                <div>Task: <strong>${escapeHtml(taskId)}</strong></div>
                <div>Behavior class: <strong>${escapeHtml(task.behavior_class || '—')}</strong></div>
                <div>Acceptable: <strong>${acceptable}</strong></div>
            `;
            behaviorPill.style.display = 'inline-block';
            behaviorPill.textContent = task.behavior_class || 'unknown';

            // Code / text blocks
            providedCode.textContent = task.provided_code ? task.provided_code : '—';
            extractedCode.textContent = (task.solution && task.solution.trim()) ? task.solution : '—';
            llmResponse.textContent = task.llm_response ? task.llm_response : '—';
            promptBlock.textContent = task.prompt ? task.prompt : '—';

            // Functions used
            functionsList.innerHTML = '';
            const funcs = Array.isArray(task.functions_used) ? task.functions_used : [];
            if (!funcs.length) {
                const span = document.createElement('span');
                span.className = 'muted';
                span.textContent = 'None';
                functionsList.appendChild(span);
            } else {
                for (const name of funcs) {
                    const chip = document.createElement('span');
                    chip.className = 'chip';
                    chip.textContent = name;
                    functionsList.appendChild(chip);
                }
            }

            // Details and token usage
            detailsText.textContent = typeof task.details === 'string' ? task.details : JSON.stringify(task.details || {}, null, 2);
            const t = task.token_usage || {};
            const tu = [t.prompt_tokens, t.completion_tokens, t.total_tokens].some(v => v !== undefined)
                ? `Token usage — prompt: ${t.prompt_tokens ?? '-'}, completion: ${t.completion_tokens ?? '-'}, total: ${t.total_tokens ?? '-'}`
                : '';
            tokenUsage.textContent = tu;
        }

        function showError(msg) {
            loading.style.display = 'block';
            content.style.display = 'none';
            loading.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function toggleSection(button) {
            const card = button.closest('.card');
            if (!card) return;
            // Find content elements inside the card, excluding the title row itself
            const title = button.parentElement; // section-title
            const children = Array.from(card.children).filter(el => el !== title);
            const isHidden = children.every(el => el.style.display === 'none');
            if (isHidden) {
                children.forEach(el => el.style.display = '');
                button.textContent = 'Minimize';
            } else {
                children.forEach(el => el.style.display = 'none');
                button.textContent = 'Show';
            }
        }
    </script>
</body>
</html>


