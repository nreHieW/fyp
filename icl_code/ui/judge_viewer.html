<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judge Evaluation Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header h1 { color: #2c3e50; margin-bottom: 10px; }
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .file-input { padding: 8px 15px; border: 2px solid #3498db; border-radius: 5px; background: white; cursor: pointer; }
        .search-box { padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; background: white; min-width: 300px; }
        
        .metrics { display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        .metric { background: #ecf0f1; padding: 5px 10px; border-radius: 5px; font-size: 14px; }
        
        .sample-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; }
        .sample-header { background: #34495e; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .task-id { font-weight: bold; font-size: 1.1em; }
        .constraint-info { font-size: 0.9em; opacity: 0.9; }
        
        .sample-content { padding: 20px; }
        .section { margin-bottom: 20px; }
        .section-title { font-weight: bold; color: #495057; margin-bottom: 10px; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; }
        
        .code-block { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; white-space: pre-wrap; overflow-x: auto; }
        
        .compliance-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .compliance-table th, .compliance-table td { border: 1px solid #dee2e6; padding: 8px 12px; text-align: left; }
        .compliance-table th { background: #f8f9fa; font-weight: bold; }
        .compliance-true { background: #d4edda; color: #155724; }
        .compliance-false { background: #f8d7da; color: #721c24; }
        .majority-vote { background: #fff3cd; color: #856404; font-weight: bold; }
        
        .collapsible { max-height: 200px; overflow: hidden; position: relative; }
        .collapsible.expanded { max-height: none; }
        .collapsible::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, #f8f9fa); pointer-events: none; }
        .collapsible.expanded::after { display: none; }
        
        .toggle-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-top: 10px; }
        .toggle-btn:hover { background: #5a6268; }
        
        .judge-response { margin-top: 15px; }
        .judge-name { font-weight: bold; color: #495057; margin-bottom: 5px; }
        .llm-response { background: #e7f3ff; border: 1px solid #b8daff; border-radius: 6px; padding: 12px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; }
        
        .no-data { text-align: center; padding: 50px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Judge Evaluation Viewer</h1>
            <p>Analyze judge model performance on constraint compliance evaluation</p>
            
            <div class="controls">
                <input type="file" id="fileInput" class="file-input" accept=".jsonl" />
                <input type="text" id="searchBox" class="search-box" placeholder="Search by task ID..." />
            </div>
            
            <div class="metrics" id="metrics" style="display: none;"></div>
        </div>
        
        <div class="no-data" id="noData">
            <h3>No Data Loaded</h3>
            <p>Please select a judge evaluation JSONL file to view the results.</p>
        </div>
        
        <div id="samplesContainer" style="display: none;"></div>
    </div>

    <script>
        let allSamples = [];
        let metadata = {};

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('searchBox').addEventListener('input', filterSamples);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.trim().split('\n');
                    allSamples = [];
                    metadata = {};

                    lines.forEach(line => {
                        const data = JSON.parse(line);
                        if (data._metadata) {
                            metadata = data._metadata;
                        } else {
                            allSamples.push(data);
                        }
                    });

                    displayMetrics();
                    displaySamples(allSamples);
                    
                    document.getElementById('noData').style.display = 'none';
                    document.getElementById('samplesContainer').style.display = 'block';
                } catch (error) {
                    alert('Error parsing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function displayMetrics() {
            const metricsDiv = document.getElementById('metrics');
            if (!metadata || Object.keys(metadata).length === 0) {
                metricsDiv.style.display = 'none';
                return;
            }

            const metrics = [
                { label: 'Model', value: metadata.generation_model },
                { label: 'Total Samples', value: metadata.total_examples },
                { label: 'Variations', value: metadata.variations ? metadata.variations.join(', ') : 'N/A' }
            ];

            metricsDiv.innerHTML = '';
            metrics.forEach(metric => {
                if (metric.value !== undefined && metric.value !== null) {
                    const metricDiv = document.createElement('div');
                    metricDiv.className = 'metric';
                    metricDiv.innerHTML = `<strong>${metric.label}:</strong> ${metric.value}`;
                    metricsDiv.appendChild(metricDiv);
                }
            });

            metricsDiv.style.display = 'flex';
        }

        function displaySamples(samples) {
            const container = document.getElementById('samplesContainer');
            container.innerHTML = '';

            samples.forEach((sample, index) => {
                const card = createSampleCard(sample, index);
                container.appendChild(card);
            });
        }

        function createSampleCard(sample, index) {
            const card = document.createElement('div');
            card.className = 'sample-card';
            
            const excludedConstraint = sample.constraint_variation === 'all' ? 'None' : `Rule ${sample.constraint_variation}`;
            
            card.innerHTML = `
                <div class="sample-header">
                    <div class="task-id">${sample.task_id}</div>
                    <div class="constraint-info">Excluded: ${excludedConstraint}</div>
                </div>
                <div class="sample-content">
                    <div class="section">
                        <div class="section-title">Code Sample</div>
                        <div class="code-block collapsible" id="code-${index}">
${sample.styled_solution}
                        </div>
                        <button class="toggle-btn" onclick="toggleCollapse('code-${index}')">Show More</button>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">Compliance Evaluation</div>
                        ${createComplianceTable(sample)}
                    </div>
                    
                    ${createJudgeResponses(sample, index)}
                </div>
            `;
            
            return card;
        }

        function createComplianceTable(sample) {
            const judges = sample.judges || {};
            const majorityVote = sample.majority_vote || {};
            const groundTruth = sample.ground_truth || {};
            
            const constraintNames = Object.keys(groundTruth);
            if (constraintNames.length === 0) return '<p>No compliance data available</p>';
            
            let tableHTML = '<table class="compliance-table"><thead><tr><th>Constraint</th><th>Ground Truth</th><th>Majority Vote</th>';
            
            Object.keys(judges).forEach(judgeName => {
                if (!judges[judgeName].evaluation_error) {
                    tableHTML += `<th>${judgeName.split('/').pop()}</th>`;
                }
            });
            
            tableHTML += '</tr></thead><tbody>';
            
            constraintNames.forEach(constraint => {
                tableHTML += `<tr><td>${constraint}</td>`;
                tableHTML += `<td class="compliance-${groundTruth[constraint]}">${groundTruth[constraint] ? 'Pass' : 'Fail'}</td>`;
                tableHTML += `<td class="majority-vote compliance-${majorityVote[constraint]}">${majorityVote[constraint] ? 'Pass' : 'Fail'}</td>`;
                
                Object.keys(judges).forEach(judgeName => {
                    const judge = judges[judgeName];
                    if (!judge.evaluation_error) {
                        const compliance = judge.compliance[constraint];
                        const isCorrect = compliance === groundTruth[constraint];
                        tableHTML += `<td class="compliance-${compliance}" style="${!isCorrect ? 'opacity: 0.6; text-decoration: line-through;' : ''}">${compliance ? 'Pass' : 'Fail'}</td>`;
                    }
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        function createJudgeResponses(sample, index) {
            const judges = sample.judges || {};
            let html = '<div class="section"><div class="section-title">Judge Responses</div>';
            
            Object.keys(judges).forEach(judgeName => {
                const judge = judges[judgeName];
                if (judge.evaluation_error) {
                    html += `
                        <div class="judge-response">
                            <div class="judge-name">${judgeName} (Error)</div>
                            <div class="llm-response">Error: ${judge.error_message}</div>
                        </div>
                    `;
                } else if (judge.llm_response) {
                    html += `
                        <div class="judge-response">
                            <div class="judge-name">${judgeName}</div>
                            <div class="llm-response collapsible" id="response-${index}-${judgeName.replace(/[^a-zA-Z0-9]/g, '')}">
${judge.llm_response}
                            </div>
                            <button class="toggle-btn" onclick="toggleCollapse('response-${index}-${judgeName.replace(/[^a-zA-Z0-9]/g, '')}')">Show More</button>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            return html;
        }

        function toggleCollapse(elementId) {
            const element = document.getElementById(elementId);
            const button = element.nextElementSibling;
            
            if (element.classList.contains('expanded')) {
                element.classList.remove('expanded');
                button.textContent = 'Show More';
            } else {
                element.classList.add('expanded');
                button.textContent = 'Show Less';
            }
        }

        function filterSamples() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm) {
                displaySamples(allSamples);
                return;
            }
            
            const filtered = allSamples.filter(sample => 
                sample.task_id.toLowerCase().includes(searchTerm) ||
                (sample.styled_solution || '').toLowerCase().includes(searchTerm)
            );
            
            displaySamples(filtered);
        }
    </script>
</body>
</html>